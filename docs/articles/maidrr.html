<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Develop a Model-Agnostic Interpretable Data-driven suRRogate in R with maidrr • maidrr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Develop a Model-Agnostic Interpretable Data-driven suRRogate in R with maidrr">
<meta property="og:description" content="maidrr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">maidrr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/maidrr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://github.com/henckr/maidrr/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Develop a Model-Agnostic Interpretable Data-driven suRRogate in R with maidrr</h1>
                        <h4 class="author">Roel Henckaerts</h4>
            
      
      <small class="dont-index">Source: <a href="http://github.com/henckr/maidrr/blob/master/vignettes/maidrr.Rmd"><code>vignettes/maidrr.Rmd</code></a></small>
      <div class="hidden name"><code>maidrr.Rmd</code></div>

    </div>

    
    
<style type="text/css">
pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
</style>
<style>
body {
text-align: justify}
</style>
<div class="sourceCode"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">maidrr</span>)</pre></body></html></div>
<div id="mtpl-datasets-included-in-maidrr" class="section level2">
<h2 class="hasAnchor">
<a href="#mtpl-datasets-included-in-maidrr" class="anchor"></a>MTPL datasets included in maidrr</h2>
<p>The <code>maidrr</code> package contains two motor third party liability (MTPL) insurance portfolios, one from Belgium (BE) and one from France (FR). Both will be used to illustrate the use of <code>maidrr</code>, so let’s have a quick look at them:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">'mtpl_be'</span>) ; <span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">mtpl_be</span>, <span class="kw">give.attr</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="co">#&gt; 'data.frame':    163212 obs. of  14 variables:</span>
<span class="co">#&gt;  $ id      : int  1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="co">#&gt;  $ expo    : num  1 1 1 1 0.0466 ...</span>
<span class="co">#&gt;  $ nclaims : int  1 0 0 0 1 0 1 0 0 0 ...</span>
<span class="co">#&gt;  $ coverage: Factor w/ 3 levels "TPL","TPL+","TPL++": 1 2 1 1 1 1 3 1 3 2 ...</span>
<span class="co">#&gt;  $ ageph   : int  50 64 60 77 28 26 26 58 59 34 ...</span>
<span class="co">#&gt;  $ sex     : Factor w/ 2 levels "female","male": 2 1 2 2 1 2 2 1 2 2 ...</span>
<span class="co">#&gt;  $ bm      : int  5 5 0 0 9 11 11 11 0 7 ...</span>
<span class="co">#&gt;  $ power   : int  77 66 70 57 70 70 55 47 98 74 ...</span>
<span class="co">#&gt;  $ agec    : int  12 3 10 15 7 12 8 14 3 6 ...</span>
<span class="co">#&gt;  $ fuel    : Factor w/ 2 levels "gasoline","diesel": 1 1 2 1 1 1 1 1 1 1 ...</span>
<span class="co">#&gt;  $ use     : Factor w/ 2 levels "private","work": 1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="co">#&gt;  $ fleet   : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="co">#&gt;  $ long    : num  4.36 4.36 4.36 4.36 4.36 ...</span>
<span class="co">#&gt;  $ lat     : num  50.8 50.8 50.8 50.8 50.8 ...</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">'mtpl_fr'</span>) ; <span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">mtpl_fr</span>, <span class="kw">give.attr</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="co">#&gt; 'data.frame':    668892 obs. of  11 variables:</span>
<span class="co">#&gt;  $ id     : int  139 190 414 424 463 606 622 811 830 975 ...</span>
<span class="co">#&gt;  $ nclaims: num  1 1 1 2 1 1 1 1 1 1 ...</span>
<span class="co">#&gt;  $ expo   : num  0.75 0.14 0.14 0.62 0.31 0.84 0.75 0.76 0.68 0.73 ...</span>
<span class="co">#&gt;  $ power  : Ord.factor w/ 12 levels "4"&lt;"5"&lt;"6"&lt;"7"&lt;..: 4 9 1 7 2 7 2 2 1 6 ...</span>
<span class="co">#&gt;  $ agec   : int  1 5 0 0 0 6 0 0 10 0 ...</span>
<span class="co">#&gt;  $ ageph  : int  61 50 36 51 45 54 34 44 24 60 ...</span>
<span class="co">#&gt;  $ bm     : int  50 60 85 100 50 50 64 50 105 50 ...</span>
<span class="co">#&gt;  $ brand  : Factor w/ 11 levels "B1","B10","B11",..: 4 4 4 4 4 4 4 4 1 4 ...</span>
<span class="co">#&gt;  $ fuel   : Factor w/ 2 levels "diesel","gasoline": 2 1 2 2 2 1 2 2 2 2 ...</span>
<span class="co">#&gt;  $ popdens: int  27000 56 4792 27000 12 583 1565 3317 3064 570 ...</span>
<span class="co">#&gt;  $ region : Factor w/ 22 levels "R11","R21","R22",..: 1 6 1 1 16 21 8 21 1 21 ...</span></pre></body></html></div>
<p>The details on all the features included in the BE and FR portfolio are available in the package documentation. These can be retrieved via <code><a href="../reference/mtpl_be.html">?maidrr::mtpl_be</a></code> and <code><a href="../reference/mtpl_fr.html">?maidrr::mtpl_fr</a></code> for the BE and FR portfolio respectively.</p>
</div>
<div id="black-box-algorithm-to-start-from" class="section level2">
<h2 class="hasAnchor">
<a href="#black-box-algorithm-to-start-from" class="anchor"></a>Black box algorithm to start from</h2>
<p>A Poisson GBM is trained on each MTPL portfolio in order to model and predict the claim frequency, i.e., the number of claims filed by a policyholder. Note that the tuning parameter values are chosen rather arbitrarily as the tuning of an optimal black box algorithm is not the purpose of this vignette. The goal of <code>maidrr</code> is to obtain an interpretable surrogate model that approximates your black box as closely as possible. Let’s get started!</p>
<div class="sourceCode"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">gbm</span>)
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">54321</span>)
<span class="no">gbm_be</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gbm/man/gbm.html">gbm</a></span>(<span class="no">nclaims</span> ~ <span class="fu"><a href="https://rdrr.io/r/stats/offset.html">offset</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">expo</span>)) + <span class="no">ageph</span> + <span class="no">power</span> + <span class="no">bm</span> + <span class="no">agec</span> + <span class="no">coverage</span> + <span class="no">fuel</span> + <span class="no">sex</span> + <span class="no">fleet</span> + <span class="no">use</span>,
              <span class="kw">data</span> <span class="kw">=</span> <span class="no">mtpl_be</span>, <span class="kw">distribution</span> <span class="kw">=</span> <span class="st">'poisson'</span>, <span class="kw">shrinkage</span> <span class="kw">=</span> <span class="fl">0.01</span>, <span class="kw">n.trees</span> <span class="kw">=</span> <span class="fl">500</span>, <span class="kw">interaction.depth</span> <span class="kw">=</span> <span class="fl">3</span>)
<span class="no">gbm_fr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gbm/man/gbm.html">gbm</a></span>(<span class="no">nclaims</span> ~ <span class="fu"><a href="https://rdrr.io/r/stats/offset.html">offset</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">expo</span>)) + <span class="no">ageph</span> + <span class="no">power</span> + <span class="no">bm</span> + <span class="no">agec</span> + <span class="no">fuel</span> + <span class="no">brand</span> + <span class="no">region</span>,
              <span class="kw">data</span> <span class="kw">=</span> <span class="no">mtpl_fr</span>, <span class="kw">distribution</span> <span class="kw">=</span> <span class="st">'poisson'</span>, <span class="kw">shrinkage</span> <span class="kw">=</span> <span class="fl">0.01</span>, <span class="kw">n.trees</span> <span class="kw">=</span> <span class="fl">500</span>, <span class="kw">interaction.depth</span> <span class="kw">=</span> <span class="fl">3</span>)</pre></body></html></div>
</div>
<div id="workflow-of-the-maidrr-procedure" class="section level2">
<h2 class="hasAnchor">
<a href="#workflow-of-the-maidrr-procedure" class="anchor"></a>Workflow of the maidrr procedure</h2>
<p>This section describes the four main functions in <code>maidrr</code> that facilitate the workflow from black box to surrogate:</p>
<ol style="list-style-type: decimal">
<li>
<code>insights</code>: obtain insights from a black box model in the form of partial dependence (PD) feature effects.</li>
<li>
<code>segmentation</code>: use PDs to group feature values/levels and segment observations in a data-driven way.</li>
<li>
<code>surrogate</code>: fit a surrogate generalized linear model (GLM) with factor features to the segmented data.</li>
<li>
<code>explain</code>: explain the prediction of a surrogate GLM via the contribution of all features (and interactions).</li>
</ol>
<p>These operations are designed in a way that allows for piping via <code>%&gt;%</code> from <code>magrittr</code> to create a neat workflow: <code>bb_fit %&gt;% insights(...) %&gt;% segmentation(...) %&gt;% surrogate(...) %&gt;% explain(...)</code></p>
<div id="insights-from-the-black-box" class="section level3">
<h3 class="hasAnchor">
<a href="#insights-from-the-black-box" class="anchor"></a>Insights from the black box</h3>
<p>Call <code><a href="../reference/insights.html">insights(mfit, vars, data, interactions = 'user', hcut = 0.75, pred_fun = NULL, fx_in = NULL)</a></code> with arguments:</p>
<ul>
<li>
<code>mfit</code>: fitted model object (e.g., a “gbm” or “randomForest” object) to get insights on.</li>
<li>
<code>vars</code>: character vector specifying the features of which you want to get a better understanding.</li>
<li>
<code>data</code>: data frame containing the original training data.</li>
<li>
<code>interactions</code>: string specifying how to deal with interaction effects (only two-way interactions allowed).
<ul>
<li>
<code>"user"</code>: specify the two-way interactions yourself in <code>vars</code> as the string <code>"var1_var2"</code>. For example, to obtain the interaction effect between the age of the policyholder and power of the car, specify the following three components in <code>vars</code>: <code>"ageph"</code>, <code>"power"</code> and <code>"ageph_power"</code>.</li>
<li>
<code>"auto"</code>: automatic selection of the most important two-way interactions, determined by <code>hcut</code>.</li>
</ul>
</li>
<li>
<code>hcut</code>: numeric in the range [0,1] specifying the cut-off value for the normalized cumulative H-statistic over all two-way interactions between the features in <code>vars</code>. In a nutshell: 1) Friedman’s H-statistic, measuring interaction strength, is calculated for all two-way interactions between the features in <code>vars</code>. 2) Interactions are ordered from most to least important and the normalized cumulative sum of the H-statistic is calculated. 3) The minimal set of interactions which exceeds the value of <code>hcut</code> is retained in the output.
<ul>
<li>
<code>hcut = 0</code>: only retain the single most important interaction.</li>
<li>
<code>hcut = 1</code>: retain all possible two-way interactions.</li>
</ul>
</li>
<li>
<code>pred_fun</code>: optional prediction function for the model in <code>mfit</code> to calculate feature effects, which should be of the format <code>function(object, newdata) mean(predict(object, newdata, ...))</code>. See the argument <code>pred.fun</code> in the <code><a href="https://rdrr.io/pkg/pdp/man/partial.html">pdp::partial</a></code> function, on which <code>maidrr</code> relies to calculate model insights. This function allows to calculate effects for model classes which are not supported by <code><a href="https://rdrr.io/pkg/pdp/man/partial.html">pdp::partial</a></code>.</li>
<li>
<code>fx_in</code>: optional named list of data frames containing feature effects for features in <code>vars</code> that are already calculated beforehand, to avoid having to calculate these again. A possible use case is to supply the main effects such that only the interaction effects still need to be calculated. Precalculated interactions are ignored when <code>interactions = "auto"</code>, but can be supplied when <code>interactions = "user"</code>. In case of the latter, it is important to make sure that you supply the pure interaction effects (more on this later).</li>
</ul>
<p>To illustrate the use of the argument <code>pred_fun</code>, we define the following function for our GBMs:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">gbm_fun</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">object</span>, <span class="no">newdata</span>) <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">object</span>, <span class="no">newdata</span>, <span class="kw">n.trees</span> <span class="kw">=</span> <span class="no">object</span>$<span class="no">n.trees</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">'response'</span>))</pre></body></html></div>
<p>For the FR portfolio, we ask for the effects on all features in the GBM and one user-specified interaction:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">fx_vars_fr</span> <span class="kw">&lt;-</span> <span class="no">gbm_fr</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/insights.html">insights</a></span>(<span class="kw">vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">gbm_fr</span>$<span class="no">var.names</span>, <span class="st">'power_fuel'</span>),
                                  <span class="kw">data</span> <span class="kw">=</span> <span class="no">mtpl_fr</span>,
                                  <span class="kw">interactions</span> <span class="kw">=</span> <span class="st">'user'</span>,
                                  <span class="kw">pred_fun</span> <span class="kw">=</span> <span class="no">gbm_fun</span>)</pre></body></html></div>
<p>For the BE portfolio, we ask for the effects on all features in the GBM and the auto-selected interactions:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">fx_vars_be</span> <span class="kw">&lt;-</span> <span class="no">gbm_be</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/insights.html">insights</a></span>(<span class="kw">vars</span> <span class="kw">=</span> <span class="no">gbm_be</span>$<span class="no">var.names</span>,
                                  <span class="kw">data</span> <span class="kw">=</span> <span class="no">mtpl_be</span>,
                                  <span class="kw">interactions</span> <span class="kw">=</span> <span class="st">'auto'</span>,
                                  <span class="kw">hcut</span> <span class="kw">=</span> <span class="fl">0.75</span>,
                                  <span class="kw">pred_fun</span> <span class="kw">=</span> <span class="no">gbm_fun</span>)</pre></body></html></div>
<p>The output is a named list of <code>tibble</code> objects containing the effects, one for each feature and interaction:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="no">fx_vars_be</span>)
<span class="co">#&gt; [1] "list"</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">fx_vars_be</span>)
<span class="co">#&gt;  [1] "ageph"       "power"       "bm"          "agec"        "coverage"   </span>
<span class="co">#&gt;  [6] "fuel"        "sex"         "fleet"       "use"         "bm_agec"    </span>
<span class="co">#&gt; [11] "ageph_power" "power_bm"    "power_agec"</span></pre></body></html></div>
<p>The <code>tibble</code> for a main effect has 3 columns with standardized names <code>x, y, w</code> containing the feature value, the effect and the number of observations counts in <code>data</code> respectively:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">fx_vars_be</span><span class="kw">[[</span><span class="st">'ageph'</span>]]
<span class="co">#&gt; # A tibble: 78 x 3</span>
<span class="co">#&gt;        x     y     w</span>
<span class="co">#&gt;    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1    18 0.184    16</span>
<span class="co">#&gt;  2    19 0.184   116</span>
<span class="co">#&gt;  3    20 0.184   393</span>
<span class="co">#&gt;  4    21 0.176   700</span>
<span class="co">#&gt;  5    22 0.171   952</span>
<span class="co">#&gt;  6    23 0.171  1379</span>
<span class="co">#&gt;  7    24 0.170  2028</span>
<span class="co">#&gt;  8    25 0.168  2672</span>
<span class="co">#&gt;  9    26 0.166  2941</span>
<span class="co">#&gt; 10    27 0.160  3130</span>
<span class="co">#&gt; # … with 68 more rows</span></pre></body></html></div>
<p>The <code>tibble</code> for an interaction effect has 4 columns with standardized names <code>x1, x2, y, w</code> containing the feature values, the effect and the number of observations counts in <code>data</code> respectively:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">fx_vars_be</span><span class="kw">[[</span><span class="st">'bm_agec'</span>]]
<span class="co">#&gt; # A tibble: 1,127 x 4</span>
<span class="co">#&gt;       x1    x2      y     w</span>
<span class="co">#&gt;    &lt;int&gt; &lt;int&gt;  &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1     0     0 0.0161    85</span>
<span class="co">#&gt;  2     0     1 0.0147  3356</span>
<span class="co">#&gt;  3     0     2 0.0162  5509</span>
<span class="co">#&gt;  4     0     3 0.0162  5024</span>
<span class="co">#&gt;  5     0     4 0.0157  5065</span>
<span class="co">#&gt;  6     0     5 0.0155  4996</span>
<span class="co">#&gt;  7     0     6 0.0148  5795</span>
<span class="co">#&gt;  8     0     7 0.0139  5283</span>
<span class="co">#&gt;  9     0     8 0.0132  5321</span>
<span class="co">#&gt; 10     0     9 0.0131  4624</span>
<span class="co">#&gt; # … with 1,117 more rows</span></pre></body></html></div>
<p>Notice the difference in the scale of the feature effect, contained in column <code>y</code>, for a main and interaction effect. This comes from the fact that the interaction effects are calculated as pure interactions by subtracting both 1D effects from the 2D effect. Therefore, the main effects will be centered around the observed claim frequency, which equals to 0.1392 for the BE portfolio, while the interaction effects are centered around zero:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">fx_vars_be</span>, <span class="kw">function</span>(<span class="no">fx</span>) <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span>(<span class="no">fx</span>$<span class="no">y</span>, <span class="no">fx</span>$<span class="no">w</span>)))
<span class="co">#&gt;         ageph         power            bm          agec      coverage </span>
<span class="co">#&gt;  0.1397163010  0.1404287758  0.1395011937  0.1412762579  0.1409791926 </span>
<span class="co">#&gt;          fuel           sex         fleet           use       bm_agec </span>
<span class="co">#&gt;  0.1402338538  0.1410778289  0.1405665604  0.1406186455  0.0143610014 </span>
<span class="co">#&gt;   ageph_power      power_bm    power_agec </span>
<span class="co">#&gt;  0.0001271602 -0.0073319238  0.0016279122</span></pre></body></html></div>
<p>The function <code><a href="../reference/plot_pd.html">maidrr::plot_pd</a></code> can be used to visualize the effects. This is illustrated for a continuous feature in the BE portfolio and a categorical feature in the FR portfolio, where darker colours or larger dots indicate higher observation counts for those feature values:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="kw pkg">gridExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="no">fx_vars_be</span><span class="kw">[[</span><span class="st">'ageph'</span>]] <span class="kw">%&gt;%</span> <span class="no">plot_pd</span> + <span class="fu">ggtitle</span>(<span class="st">'MTPL BE'</span>),
                        <span class="no">fx_vars_fr</span><span class="kw">[[</span><span class="st">'brand'</span>]] <span class="kw">%&gt;%</span> <span class="no">plot_pd</span> + <span class="fu">ggtitle</span>(<span class="st">'MTPL FR'</span>),
                        <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="maidrr_files/figure-html/insights_plt_main-1.png" width="672"></p>
<p>The function <code><a href="../reference/plot_pd.html">maidrr::plot_pd</a></code> can also be used to visualize the interactions. This is illustrated for two continuous features in the BE portfolio and two categorical features in the FR portfolio. It is important to understand that these represent corrections on the main effects of those features. So young policyholders driving a high powered car receive an extra penalty on top of their main effects in the BE portfolio. In the FR portfolio one can conclude that for low powered cars diesel is more risky than gasoline, but this behaviour reverses as of power level 7 and the difference becomes even bigger as of power level 9.</p>
<div class="sourceCode"><html><body><pre class="r"><span class="kw pkg">gridExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="no">fx_vars_be</span><span class="kw">[[</span><span class="st">'ageph_power'</span>]] <span class="kw">%&gt;%</span> <span class="no">plot_pd</span> + <span class="fu">ggtitle</span>(<span class="st">'MTPL BE'</span>),
                        <span class="no">fx_vars_fr</span><span class="kw">[[</span><span class="st">'power_fuel'</span>]] <span class="kw">%&gt;%</span> <span class="no">plot_pd</span> + <span class="fu">ggtitle</span>(<span class="st">'MTPL FR'</span>),
                        <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">1</span>)</pre></body></html></div>
<p><img src="maidrr_files/figure-html/insights_plt_intr-1.png" width="672"></p>
<p>The goal of the <code>maidrr</code> procedure is to group values/levels within a feature which are showing similar behaviour. Regions where the effect is quite stable can be grouped together, for example:</p>
<ul>
<li>the age ranges 35-45 and 60-80 in the BE portfolio,</li>
<li>the brands B5, B3 and B10 in the FR portfolio,</li>
<li>ages above 30 combined with power below 170 in the BE portfolio,</li>
<li>power levels above 8 with the fuel types in the FR portfolio.</li>
</ul>
<p>Performing such a grouping in an optimal, automatic and data-driven way is the goal of <code>maidrr</code>, stay tuned!</p>
<p><strong>Note on variable selection:</strong> In the above examples we simply used all the features from the GBM (via <code>$var.names</code> on the <code>gbm</code> object). You might want to exclude unimportant features from your analysis to save computation time when many features are used in your black box model. The functions <code><a href="../reference/get_vi.html">maidrr::get_vi</a></code> and <code><a href="../reference/plot_vi.html">maidrr::plot_vi</a></code> allow to obtain some insights on the important features in the black box. The former calculates variable importance scores for all features in the model (<code>tibble</code>), while the latter plots the results (<code>ggplot</code>). These functions can be used to determine which features to supply to the <code>vars</code> argument in <code>insights</code>.</p>
<div class="sourceCode"><html><body><pre class="r"><span class="kw pkg">gridExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="no">gbm_be</span> <span class="kw">%&gt;%</span> <span class="no">get_vi</span> <span class="kw">%&gt;%</span> <span class="no">plot_vi</span> + <span class="fu">ggtitle</span>(<span class="st">'MTPL BE'</span>),
                        <span class="no">gbm_fr</span> <span class="kw">%&gt;%</span> <span class="no">get_vi</span> <span class="kw">%&gt;%</span> <span class="no">plot_vi</span> + <span class="fu">ggtitle</span>(<span class="st">'MTPL FR'</span>),
                        <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="maidrr_files/figure-html/insights_vi-1.png" width="672"></p>
<div id="helper-functions" class="section level4">
<h4 class="hasAnchor">
<a href="#helper-functions" class="anchor"></a>Helper functions</h4>
<p>The function <code>insights</code> streamlines the exploration process by making use of several <code>maidrr</code> helper functions:</p>
<ul>
<li>
<code>get_pd</code>: calculates the partial dependence (PD) effect for a specific feature (1D) or pair of features (2D).</li>
<li>
<code>get_grid</code>: determines the grid on which to evaluate the PD effect (based on the observed data values).</li>
<li>
<code>interaction_pd</code>: computes the pure interaction effect by subtracting both 1D PDs from the 2D PD.</li>
<li>
<code>interaction_strength</code>: calculates Friedman’s H-statistic for the interaction strength of two features.</li>
</ul>
<p>These functions can be used on a stand-alone basis to perform your own tailored analysis. Details on the use of these functions and input requirements are available in the documentation of <code>maidrr</code>.</p>
</div>
</div>
<div id="segmantation-of-the-data" class="section level3">
<h3 class="hasAnchor">
<a href="#segmantation-of-the-data" class="anchor"></a>Segmantation of the data</h3>
<p>Call <code><a href="../reference/segmentation.html">segmentation(fx_vars, data, type, values)</a></code> with arguments:</p>
<ul>
<li>
<code>fx_vars</code>: list of data frames containing the feature effects, preferably the output of <code><a href="../reference/insights.html">maidrr::insights</a></code>.</li>
<li>
<code>data</code>: data frame containing the original training data.</li>
<li>
<code>type</code>: string specifying the type of segmentation to perform. There are two options:
<ul>
<li>
<code>"ngroups"</code>: the number of groups to use for grouping the features.</li>
<li>
<code>"lambdas"</code>: the optimal number of groups are determined by the penalized loss (formula below).</li>
</ul>
</li>
<li>
<code>values</code>: numeric value or named numeric vector with the values for <code>ngroups</code> of <code>lambdas</code>.
<ul>
<li>numeric value: same value is used for all features in <code>fx_vars</code>.</li>
<li>named numeric vector: feature-specific values, must satisfy <code>length(values) == length(fx_vars)</code> and <code><a href="https://rdrr.io/r/base/names.html">names(values)</a></code> must be the same as the comment attributes of the effects in <code>fx_vars</code> as detemrined by <code><a href="https://rdrr.io/r/base/unlist.html">unlist(lapply(fx_vars, comment))</a></code>.</li>
</ul>
</li>
</ul>
<p>For any feature, let <em>n</em> be the unique number of observed levels/values in the data and <em>y</em> the calculated effect for each level/value. When the feature is split in <em>k</em> groups, let <em>g</em> represent the average value of <em>y</em> within the groups. A penalized loss function is defined as follows: <span class="math display">\[ \frac{1}{n} \sum_{i=1}^{n} \left( y_i - g_i \right)^2 + \lambda \log(k)  \,. \]</span> The first part measures how well the effect <em>y</em> is approximated by the grouped variant <em>g</em> in the form of a mean squared error over all levels/values of the feature. The second part measures the complexity of the grouping by means of the common logarithm of the number of groups <em>k</em> for the feature. The penalty parameter <span class="math inline">\(\lambda\)</span> acts as a bias-variance trade-off. A low value will allow a lot of groups, resulting in an accurate approximation of the effect. A high value will enforce using fewer groups, resulting in a coarse approximation of the effect. For a specified value of <span class="math inline">\(\lambda\)</span>, the optimal number of groups <em>k</em> follows by minimizing the penalized loss function. The grouping in <code>maidrr</code> is done via the <code>Ckmeans.1d.dp</code> package.</p>
<p>We segment the BE portfolio by specifying feature-specific number of groups. The grouped features are added to the <code>data</code> with a trailing underscore in their column name:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">gr_data_be</span> <span class="kw">&lt;-</span> <span class="no">fx_vars_be</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/segmentation.html">segmentation</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">mtpl_be</span>,
                                          <span class="kw">type</span> <span class="kw">=</span> <span class="st">'ngroups'</span>,
                                          <span class="kw">values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">7</span>, <span class="fl">4</span>, <span class="fl">9</span>, <span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">2</span>),
                                                            <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">fx_vars_be</span>, <span class="no">comment</span>))))
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">gr_data_be</span>)
<span class="co">#&gt;   id       expo nclaims coverage ageph    sex bm power agec     fuel     use</span>
<span class="co">#&gt; 1  1 1.00000000       1      TPL    50   male  5    77   12 gasoline private</span>
<span class="co">#&gt; 2  2 1.00000000       0     TPL+    64 female  5    66    3 gasoline private</span>
<span class="co">#&gt; 3  3 1.00000000       0      TPL    60   male  0    70   10   diesel private</span>
<span class="co">#&gt; 4  4 1.00000000       0      TPL    77   male  0    57   15 gasoline private</span>
<span class="co">#&gt; 5  5 0.04657534       1      TPL    28 female  9    70    7 gasoline private</span>
<span class="co">#&gt; 6  6 1.00000000       0      TPL    26   male 11    70   12 gasoline private</span>
<span class="co">#&gt;   fleet    long      lat   ageph_    power_      bm_   agec_     coverage_</span>
<span class="co">#&gt; 1     0 4.35522 50.84539 [50, 57] [68, 170]   [3, 6] [0, 17]         {TPL}</span>
<span class="co">#&gt; 2     0 4.35522 50.84539 [58, 95]  [39, 67]   [3, 6] [0, 17] {TPL+, TPL++}</span>
<span class="co">#&gt; 3     0 4.35522 50.84539 [58, 95] [68, 170]   [0, 1] [0, 17]         {TPL}</span>
<span class="co">#&gt; 4     0 4.35522 50.84539 [58, 95]  [39, 67]   [0, 1] [0, 17]         {TPL}</span>
<span class="co">#&gt; 5     0 4.35522 50.84539 [27, 29] [68, 170]   [8, 9] [0, 17]         {TPL}</span>
<span class="co">#&gt; 6     0 4.35522 50.84539 [21, 26] [68, 170] [11, 15] [0, 17]         {TPL}</span>
<span class="co">#&gt;        fuel_     sex_ fleet_            use_ bm_agec_ ageph_power_ power_bm_</span>
<span class="co">#&gt; 1 {gasoline}   {male} {0, 1} {private, work}        2            2         2</span>
<span class="co">#&gt; 2 {gasoline} {female} {0, 1} {private, work}        2            2         2</span>
<span class="co">#&gt; 3   {diesel}   {male} {0, 1} {private, work}        2            2         2</span>
<span class="co">#&gt; 4 {gasoline}   {male} {0, 1} {private, work}        2            2         2</span>
<span class="co">#&gt; 5 {gasoline} {female} {0, 1} {private, work}        2            2         2</span>
<span class="co">#&gt; 6 {gasoline}   {male} {0, 1} {private, work}        2            2         3</span>
<span class="co">#&gt;   power_agec_</span>
<span class="co">#&gt; 1           2</span>
<span class="co">#&gt; 2           2</span>
<span class="co">#&gt; 3           2</span>
<span class="co">#&gt; 4           2</span>
<span class="co">#&gt; 5           2</span>
<span class="co">#&gt; 6           2</span>
<span class="no">gr_data_be</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">ends_with</a></span>(<span class="st">'_'</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span>(<span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="no"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span>)
<span class="co">#&gt;   ageph_ power_ bm_ agec_ coverage_ fuel_ sex_ fleet_ use_ bm_agec_</span>
<span class="co">#&gt; 1      7      4   9     3         2     2    2      1    1        2</span>
<span class="co">#&gt;   ageph_power_ power_bm_ power_agec_</span>
<span class="co">#&gt; 1            3         4           2</span></pre></body></html></div>
<p>We segment the FR portfolio by specifying a single <span class="math inline">\(\lambda\)</span> value for all features and the interaction:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">gr_data_fr</span> <span class="kw">&lt;-</span> <span class="no">fx_vars_fr</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/segmentation.html">segmentation</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">mtpl_fr</span>,
                                          <span class="kw">type</span> <span class="kw">=</span> <span class="st">'lambdas'</span>,
                                          <span class="kw">values</span> <span class="kw">=</span> <span class="fl">0.000001</span>)
<span class="no">gr_data_fr</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">ends_with</a></span>(<span class="st">'_'</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span>(<span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="no"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span>)
<span class="co">#&gt;   ageph_ power_ bm_ agec_ fuel_ brand_ region_ power_fuel_</span>
<span class="co">#&gt; 1      9      2  15     3     2      5       8           1</span></pre></body></html></div>
<p>It is possible to use <code><a href="../reference/plot_pd.html">maidrr::plot_pd</a></code> with <code><a href="../reference/group_pd.html">maidrr::group_pd</a></code> to get an idea of the actual grouping of features:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="kw pkg">gridExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="no">fx_vars_be</span><span class="kw">[[</span><span class="st">'ageph'</span>]] <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/group_pd.html">group_pd</a></span>(<span class="kw">ngroups</span> <span class="kw">=</span> <span class="fl">7</span>) <span class="kw">%&gt;%</span> <span class="no">plot_pd</span> + <span class="fu">ggtitle</span>(<span class="st">'MTPL BE'</span>),
                        <span class="no">fx_vars_fr</span><span class="kw">[[</span><span class="st">'brand'</span>]] <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/group_pd.html">group_pd</a></span>(<span class="kw">ngroups</span> <span class="kw">=</span> <span class="fl">5</span>) <span class="kw">%&gt;%</span> <span class="no">plot_pd</span> + <span class="fu">ggtitle</span>(<span class="st">'MTPL FR'</span>),
                        <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="maidrr_files/figure-html/segmentation_plt_main-1.png" width="672"></p>
<p>The same can be done for the two interaction effects that we saw earlier:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="kw pkg">gridExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="no">fx_vars_be</span><span class="kw">[[</span><span class="st">'ageph_power'</span>]] <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/group_pd.html">group_pd</a></span>(<span class="kw">ngroups</span> <span class="kw">=</span> <span class="fl">3</span>) <span class="kw">%&gt;%</span> <span class="no">plot_pd</span> + <span class="fu">ggtitle</span>(<span class="st">'MTPL BE'</span>),
                        <span class="no">fx_vars_fr</span><span class="kw">[[</span><span class="st">'power_fuel'</span>]] <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/group_pd.html">group_pd</a></span>(<span class="kw">ngroups</span> <span class="kw">=</span> <span class="fl">4</span>) <span class="kw">%&gt;%</span> <span class="no">plot_pd</span> + <span class="fu">ggtitle</span>(<span class="st">'MTPL FR'</span>),
                        <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="maidrr_files/figure-html/segmentation_plt_intr-1.png" width="672"></p>
<p>The choice of the value(s) for <span class="math inline">\(\lambda\)</span> is the most important aspect in the <code>maidrr</code> procedure, as it will determine the level of segmentation in your data. You can tune this parameter yourself or rely on the <code><a href="../reference/autotune.html">maidrr::autotune</a></code> function, which is introduced <a href="#auto">later</a>. First, we still need to cover the topic of fitting the actual surrogate model.</p>
<div id="helper-functions-1" class="section level4">
<h4 class="hasAnchor">
<a href="#helper-functions-1" class="anchor"></a>Helper functions</h4>
<p>The function <code>segmentation</code> streamlines the grouping process by making use of several <code>maidrr</code> helper functions:</p>
<ul>
<li>
<code>group_pd</code>: groups the effect in an optimal way by making use of the <code>Ckmeans.1d.dp</code> package.</li>
<li>
<code>optimal_ngroups</code>: determines the optimal number of groups for an effect and a specified value of <span class="math inline">\(\lambda\)</span>.</li>
</ul>
<p>These functions can be used on a stand-alone basis to perform your own tailored analysis. Details on the use of these functions and input requirements are available in the documentation of <code>maidrr</code>.</p>
</div>
</div>
<div id="fitting-a-surrogate-glm" class="section level3">
<h3 class="hasAnchor">
<a href="#fitting-a-surrogate-glm" class="anchor"></a>Fitting a surrogate GLM</h3>
<p>Call <code><a href="../reference/surrogate.html">surrogate(data, par_list)</a></code> with arguments:</p>
<ul>
<li>
<code>data</code>: data frame containing the segmented training data, preferably the output of <code><a href="../reference/segmentation.html">maidrr::segmentation</a></code>.</li>
<li>
<code>par_list</code>: named list, constructed via <code><a href="https://rdrr.io/r/base/list.html">alist()</a></code>, with additional arguments to be passed on to <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code>. Refer to <code><a href="https://rdrr.io/r/stats/glm.html">?glm</a></code> for all the options, but some common examples are:
<ul>
<li>formula: object of the class <code>formula</code> with a symbolic description of the GLM to be fitted.</li>
<li>family: description of the error distribution and link function to be used in the GLM.</li>
<li>weights: vector of prior weights to be used in the fitting process.</li>
<li>offset: a priori known component to be included in the linear predictor during fitting.</li>
</ul>
</li>
</ul>
<p>It is important to only include featues with at least 2 groups in the <code>formula</code>, the rest is captured by the intercept.</p>
<p>Let’s fit a surrogate Poisson GLM to the segmented BE portfolio with exposure as offset (same specs as GBM):</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">features_be</span> <span class="kw">&lt;-</span> <span class="no">gr_data_be</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">ends_with</a></span>(<span class="st">'_'</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span>(~<span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span>(<span class="no">.</span>) <span class="kw">&gt;</span> <span class="fl">1</span>) <span class="kw">%&gt;%</span>
  <span class="no">unlist</span> <span class="kw">%&gt;%</span> <span class="no">which</span> <span class="kw">%&gt;%</span> <span class="no">names</span>
<span class="no">features_be</span>
<span class="co">#&gt;  [1] "ageph_"       "power_"       "bm_"          "agec_"        "coverage_"   </span>
<span class="co">#&gt;  [6] "fuel_"        "sex_"         "bm_agec_"     "ageph_power_" "power_bm_"   </span>
<span class="co">#&gt; [11] "power_agec_"</span>

<span class="no">formula_be</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">'nclaims ~'</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">features_be</span>, <span class="kw">collapse</span> <span class="kw">=</span> <span class="st">'+'</span>)))
<span class="no">formula_be</span>
<span class="co">#&gt; nclaims ~ ageph_ + power_ + bm_ + agec_ + coverage_ + fuel_ + </span>
<span class="co">#&gt;     sex_ + bm_agec_ + ageph_power_ + power_bm_ + power_agec_</span>

<span class="no">glm_be</span> <span class="kw">&lt;-</span> <span class="no">gr_data_be</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/surrogate.html">surrogate</a></span>(<span class="kw">par_list</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">alist</a></span>(<span class="kw">formula</span> <span class="kw">=</span> <span class="no">formula_be</span>,
                                                    <span class="kw">family</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span>(<span class="kw">link</span> <span class="kw">=</span> <span class="st">'log'</span>),
                                                    <span class="kw">offset</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">expo</span>)))
<span class="no">glm_be</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:  glm(formula = formula_be, family = poisson(link = "log"), data = data, </span>
<span class="co">#&gt;     offset = log(expo))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;            (Intercept)          ageph_[18, 20]          ageph_[21, 26]  </span>
<span class="co">#&gt;               -2.19832                 0.34812                 0.18439  </span>
<span class="co">#&gt;         ageph_[27, 29]          ageph_[30, 31]          ageph_[50, 57]  </span>
<span class="co">#&gt;                0.10251                 0.04566                -0.07404  </span>
<span class="co">#&gt;         ageph_[58, 95]          power_[10, 38]        power_[173, 243]  </span>
<span class="co">#&gt;               -0.22054                -0.14413                 0.92671  </span>
<span class="co">#&gt;        power_[68, 170]             bm_[10, 10]             bm_[11, 15]  </span>
<span class="co">#&gt;                0.10959                 0.59858                 0.78451  </span>
<span class="co">#&gt;            bm_[16, 17]             bm_[18, 22]               bm_[2, 2]  </span>
<span class="co">#&gt;                0.94017                 0.95645                 0.15215  </span>
<span class="co">#&gt;              bm_[3, 6]               bm_[7, 7]               bm_[8, 9]  </span>
<span class="co">#&gt;                0.31476                 0.43245                 0.48204  </span>
<span class="co">#&gt;          agec_[18, 29]           agec_[30, 48]  coverage_{TPL+, TPL++}  </span>
<span class="co">#&gt;               -0.29664                -1.70068                -0.07476  </span>
<span class="co">#&gt;          fuel_{diesel}            sex_{female}               bm_agec_1  </span>
<span class="co">#&gt;                0.15278                 0.02158                -0.56058  </span>
<span class="co">#&gt;          ageph_power_1           ageph_power_3              power_bm_1  </span>
<span class="co">#&gt;               -0.15247                 0.55170                -0.04152  </span>
<span class="co">#&gt;             power_bm_3              power_bm_4            power_agec_1  </span>
<span class="co">#&gt;                0.05409                -0.01740                -5.59508  </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Degrees of Freedom: 163211 Total (i.e. Null);  163182 Residual</span>
<span class="co">#&gt; Null Deviance:       89880 </span>
<span class="co">#&gt; Residual Deviance: 87140     AIC: 124900</span></pre></body></html></div>
<p>Some conclusions can be drawn fast and easily from the fitted GLM coeffients:</p>
<ul>
<li>young policyholders are more risky compared to the older ones,</li>
<li>low powered cars are less risky compared to the high powerded ones,</li>
<li>the risk is monotonically increasing in the bonus-malus level,</li>
<li>policyholders driving a new car are more prone to file a claim,</li>
<li>policyholders with extended coverage above the standard TPL cover are less risky and</li>
<li>policyholders driving diesel cars are more risky compared to those driving a gasoline car.</li>
</ul>
<p>Let’s also fit a surrogate Poisson GLM to the segmented FR portfolio with exposure as offset:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">features_fr</span> <span class="kw">&lt;-</span> <span class="no">gr_data_fr</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">ends_with</a></span>(<span class="st">'_'</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span>(~<span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span>(<span class="no">.</span>) <span class="kw">&gt;</span> <span class="fl">1</span>) <span class="kw">%&gt;%</span>
  <span class="no">unlist</span> <span class="kw">%&gt;%</span> <span class="no">which</span> <span class="kw">%&gt;%</span> <span class="no">names</span>
<span class="no">features_fr</span>
<span class="co">#&gt; [1] "ageph_"  "power_"  "bm_"     "agec_"   "fuel_"   "brand_"  "region_"</span>

<span class="no">formula_fr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">'nclaims ~'</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">features_fr</span>, <span class="kw">collapse</span> <span class="kw">=</span> <span class="st">'+'</span>)))
<span class="no">formula_fr</span>
<span class="co">#&gt; nclaims ~ ageph_ + power_ + bm_ + agec_ + fuel_ + brand_ + region_</span>

<span class="no">glm_fr</span> <span class="kw">&lt;-</span> <span class="no">gr_data_fr</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/surrogate.html">surrogate</a></span>(<span class="kw">par_list</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">alist</a></span>(<span class="kw">formula</span> <span class="kw">=</span> <span class="no">formula_fr</span>,
                                                    <span class="kw">family</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span>(<span class="kw">link</span> <span class="kw">=</span> <span class="st">'log'</span>),
                                                    <span class="kw">offset</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">expo</span>)))
<span class="no">glm_fr</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:  glm(formula = formula_fr, family = poisson(link = "log"), data = data, </span>
<span class="co">#&gt;     offset = log(expo))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;                      (Intercept)                    ageph_[18, 19]  </span>
<span class="co">#&gt;                         -3.00517                           0.25375  </span>
<span class="co">#&gt;                   ageph_[20, 20]                    ageph_[21, 22]  </span>
<span class="co">#&gt;                          0.04351                          -0.15163  </span>
<span class="co">#&gt;                   ageph_[23, 35]                    ageph_[36, 38]  </span>
<span class="co">#&gt;                         -0.39965                          -0.22046  </span>
<span class="co">#&gt;                   ageph_[39, 40]                    ageph_[41, 42]  </span>
<span class="co">#&gt;                         -0.17761                          -0.08060  </span>
<span class="co">#&gt;                   ageph_[43, 43]                     power_[6, 12]  </span>
<span class="co">#&gt;                         -0.01839                           0.17762  </span>
<span class="co">#&gt;                    bm_[101, 107]                     bm_[108, 120]  </span>
<span class="co">#&gt;                          1.88995                           1.95790  </span>
<span class="co">#&gt;                    bm_[121, 124]                     bm_[125, 144]  </span>
<span class="co">#&gt;                          2.35288                           2.24336  </span>
<span class="co">#&gt;                    bm_[147, 185]                     bm_[187, 230]  </span>
<span class="co">#&gt;                          2.37733                           2.96728  </span>
<span class="co">#&gt;                      bm_[55, 57]                       bm_[58, 60]  </span>
<span class="co">#&gt;                          0.46495                           0.71669  </span>
<span class="co">#&gt;                      bm_[61, 62]                       bm_[63, 76]  </span>
<span class="co">#&gt;                          1.56905                           0.74449  </span>
<span class="co">#&gt;                      bm_[77, 77]                       bm_[78, 90]  </span>
<span class="co">#&gt;                          1.89663                           0.91610  </span>
<span class="co">#&gt;                      bm_[91, 95]                      bm_[96, 100]  </span>
<span class="co">#&gt;                          1.15974                           1.56836  </span>
<span class="co">#&gt;                    agec_[13, 15]                    agec_[16, 100]  </span>
<span class="co">#&gt;                         -0.20759                          -0.36434  </span>
<span class="co">#&gt;                    fuel_{diesel}          brand_{B10, B11, B3, B5}  </span>
<span class="co">#&gt;                          0.14003                           0.08195  </span>
<span class="co">#&gt;                      brand_{B12}                   brand_{B13, B6}  </span>
<span class="co">#&gt;                         -0.24574                           0.03356  </span>
<span class="co">#&gt;                      brand_{B14}                 region_{R11, R22}  </span>
<span class="co">#&gt;                         -0.19237                           0.20565  </span>
<span class="co">#&gt;      region_{R21, R23, R25, R43}                 region_{R31, R42}  </span>
<span class="co">#&gt;                          0.03975                           0.14085  </span>
<span class="co">#&gt; region_{R52, R53, R54, R72, R94}                 region_{R73, R83}  </span>
<span class="co">#&gt;                          0.08455                          -0.14305  </span>
<span class="co">#&gt;                region_{R74, R93}                      region_{R82}  </span>
<span class="co">#&gt;                          0.23422                           0.30333  </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Degrees of Freedom: 668891 Total (i.e. Null);  668854 Residual</span>
<span class="co">#&gt; Null Deviance:       170500 </span>
<span class="co">#&gt; Residual Deviance: 161500    AIC: 212300</span></pre></body></html></div>
<p>Global model conclusions can again be drawn from the fitted GLM coefficients. However, let’s turn the focus on explaining predictions for individual observations in the next section.</p>
</div>
<div id="explaining-the-predictions" class="section level3">
<h3 class="hasAnchor">
<a href="#explaining-the-predictions" class="anchor"></a>Explaining the predictions</h3>
<p>Call <code><a href="../reference/explain.html">explain(surro, instance, plt = TRUE)</a></code> with arguments:</p>
<ul>
<li>
<code>surro</code>: surrogate GLM object of class <code>glm</code>, preferably the output of <code><a href="../reference/surrogate.html">maidrr::surrogate</a></code>.</li>
<li>
<code>instance</code>: single row data frame with the instance to be explained.</li>
<li>
<code>plt</code>: boolean whether to return a ggplot (TRUE) or the underlying data (FALSE).
<ul>
<li>
<code>plt = FALSE</code>: the columns <code>fit_link</code> and <code>se_link</code> contain the fitted coefficient and standard error on the linear predictor scale. The column <code>fit_resp</code> contains the coefficient on the response scale after taking the inverse link function, while <code>upr_conf</code> and <code>lwr_conf</code> contain the upper and lower bound of a 95% confidence interval.</li>
<li>
<code>plt = TRUE</code>: shows the coefficient and confidence interval on the response scale. A green dashed line shows the value of the invere link function applied to zero. Features with bars close to this line have a neglegible impact on the predition.</li>
</ul>
</li>
</ul>
<p>Let’s explain the prediction made by the BE GLM for two policyholders (id 34 and 4938). Notice that the prediction for the former is below the intercept of the GLM, while it is more than doubled for the latter. Why is this the case? The low risk for id 34 is mainly thanks to a low bonus-malus level and high age. Driving a high powered car increases the risk on the other hand. The high risk for id 4938 is mainly due to a high bonus-malus level and young age. Note that these contributions and confidence intervals are shown on the response scale after taking the invere link function of the coefficients. For a Poisson GLM with <code>log</code>-link function this implies applying the <code>exp</code> function on the coefficients, with contributions on the multiplicative response scale and a value of 1 indicating no contribution.</p>
<div class="sourceCode"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">glm_be</span>)[<span class="st">'(Intercept)'</span>])
<span class="co">#&gt; (Intercept) </span>
<span class="co">#&gt;   0.1109892</span>
<span class="no">glm_be</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="kw">newdata</span> <span class="kw">=</span> <span class="no">gr_data_be</span>[<span class="fl">34</span>, ], <span class="kw">type</span> <span class="kw">=</span> <span class="st">'response'</span>) / <span class="no">gr_data_be</span>[<span class="fl">34</span>, <span class="st">'expo'</span>]
<span class="co">#&gt;         34 </span>
<span class="co">#&gt; 0.09217816</span>
<span class="no">glm_be</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="kw">newdata</span> <span class="kw">=</span> <span class="no">gr_data_be</span>[<span class="fl">4938</span>, ], <span class="kw">type</span> <span class="kw">=</span> <span class="st">'response'</span>) / <span class="no">gr_data_be</span>[<span class="fl">4938</span>, <span class="st">'expo'</span>]
<span class="co">#&gt;      4938 </span>
<span class="co">#&gt; 0.2518014</span>

<span class="kw pkg">gridExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="no">glm_be</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/explain.html">explain</a></span>(<span class="kw">instance</span> <span class="kw">=</span> <span class="no">gr_data_be</span>[<span class="fl">34</span>, ]) + <span class="fu">ggtitle</span>(<span class="st">'ID 34'</span>),
                        <span class="no">glm_be</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/explain.html">explain</a></span>(<span class="kw">instance</span> <span class="kw">=</span> <span class="no">gr_data_be</span>[<span class="fl">4938</span>, ]) + <span class="fu">ggtitle</span>(<span class="st">'ID 4938'</span>),
                        <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="maidrr_files/figure-html/explain_be-1.png" width="672"></p>
<p>We can follow the same approach for the FR GLM for two policyholders (id 34 and 4938). The prediction for the former is below the GLM intercept, while it is more than doubled for the latter. Why is this the case? The low risk for id 34 is mainly thanks to a low bonus-malus level and driving a car of brand B12 (we have seen this before in the PD effect). The high risk for id 4938 is mainly driven by a high bonus-malus level.</p>
<div class="sourceCode"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">glm_fr</span>)[<span class="st">'(Intercept)'</span>])
<span class="co">#&gt; (Intercept) </span>
<span class="co">#&gt;  0.04953016</span>
<span class="no">glm_fr</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="kw">newdata</span> <span class="kw">=</span> <span class="no">gr_data_fr</span>[<span class="fl">34</span>, ], <span class="kw">type</span> <span class="kw">=</span> <span class="st">'response'</span>) / <span class="no">gr_data_fr</span>[<span class="fl">34</span>, <span class="st">'expo'</span>]
<span class="co">#&gt;         34 </span>
<span class="co">#&gt; 0.03873885</span>
<span class="no">glm_fr</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="kw">newdata</span> <span class="kw">=</span> <span class="no">gr_data_fr</span>[<span class="fl">4938</span>, ], <span class="kw">type</span> <span class="kw">=</span> <span class="st">'response'</span>) / <span class="no">gr_data_fr</span>[<span class="fl">4938</span>, <span class="st">'expo'</span>]
<span class="co">#&gt;      4938 </span>
<span class="co">#&gt; 0.1046914</span>

<span class="kw pkg">gridExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="no">glm_fr</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/explain.html">explain</a></span>(<span class="kw">instance</span> <span class="kw">=</span> <span class="no">gr_data_fr</span>[<span class="fl">34</span>, ]) + <span class="fu">ggtitle</span>(<span class="st">'ID 34'</span>),
                        <span class="no">glm_fr</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/explain.html">explain</a></span>(<span class="kw">instance</span> <span class="kw">=</span> <span class="no">gr_data_fr</span>[<span class="fl">4938</span>, ]) + <span class="fu">ggtitle</span>(<span class="st">'ID 4938'</span>),
                        <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="maidrr_files/figure-html/explain_fr-1.png" width="672"></p>
<p>These are of course just toy examples to illustrate the functionalty of <code>maidrr</code>, with random segmentation choices (the values for the number of groups or <span class="math inline">\(\lambda\)</span>). Tuning the value of <span class="math inline">\(\lambda\)</span> is very important to obtain competitive prediction models. Therefore, we incorporate a function to automate this task for you: <code><a href="../reference/autotune.html">maidrr::autotune</a></code>.</p>
<p><a id="auto"></a></p>
</div>
</div>
<div id="automated-lambda-tuning-via-cross-validation" class="section level2">
<h2 class="hasAnchor">
<a href="#automated-lambda-tuning-via-cross-validation" class="anchor"></a>Automated lambda tuning via cross-validation</h2>
<p>The <code>maidrr</code> workflow from black box to surrogate via <code>insights %&gt;% segmentation %&gt;% surrogate</code> is highly dependend on the value(s) of <span class="math inline">\(\lambda\)</span> supplied to <code><a href="../reference/segmentation.html">maidrr::segmentation</a></code>. The grouping and selection of features is entirely dependend on <span class="math inline">\(\lambda\)</span> via the penalized loss function. Any ad-hoc choice is most likely to result in a surrogate which is not really competitive with the original black box model, so it is important to choose the value(s) for <span class="math inline">\(\lambda\)</span> in an optimal way. To automate this tuning task, <code>maidrr</code> contains the <code><a href="../reference/autotune.html">autotune(...)</a></code> function. This function iterates over a grid of <span class="math inline">\(\lambda\)</span>’s, calculating cross-validation errors for each grid value, and returns an optimal surrogate GLM.</p>
<p>Call <code>autotune(mfit, data, vars, target, hcut = 0.75, pred_fun = NULL,</code> <code>lambdas = as.vector(outer(seq(1, 10, 0.1), 10^(-7:3))), nfolds = 5, strat_vars = NULL,</code> <code>glm_par = alist(), err_fun = mse, ncores = -1)</code> with arguments:</p>
<ul>
<li>
<code>mfit</code>: fitted model object (e.g., a “gbm” or “randomForest” object) to approximate with a surrogate.</li>
<li>
<code>data</code>: data frame containing the original training data.</li>
<li>
<code>vars</code>: character vector specifying which features of <code>data</code> to consider for inclusion in the surrogate. Automatic feature selection will choose the best performing subset of features, possibly with interactions.</li>
<li>
<code>target</code>: string specifying the name of the target (or response) variable to model.</li>
<li>
<code>hcut</code>: numeric in the range [0,1] specifying the cut-off value for the normalized cumulative H-statistic over all two-way interactions between the features in <code>vars</code>. In a nutshell: 1) Friedman’s H-statistic, measuring interaction strength, is calculated for all two-way interactions between the features in <code>vars</code>. 2) Interactions are ordered from most to least important and the normalized cumulative sum of the H-statistic is calculated. 3) The minimal set of interactions which exceeds the value of <code>hcut</code> is retained in the output.
<ul>
<li>
<code>hcut = 0</code>: only consider the single most important interaction for inclusion in the surrogate.</li>
<li>
<code>hcut = 1</code>: consider all possible two-way interactions for inclusion in the surrogate.</li>
<li>
<code>hcut = -1</code>: do not consider interactions and only use main effects of the features in <code>vars</code>.</li>
</ul>
</li>
<li>
<code>pred_fun</code>: optional prediction function for the model in <code>mfit</code> to calculate feature effects, which should be of the format <code>function(object, newdata) mean(predict(object, newdata, ...))</code>. See the argument <code>pred.fun</code> in the <code><a href="https://rdrr.io/pkg/pdp/man/partial.html">pdp::partial</a></code> function, on which <code>maidrr</code> relies to calculate model insights. This function allows to calculate effects for model classes which are not supported by <code><a href="https://rdrr.io/pkg/pdp/man/partial.html">pdp::partial</a></code>, see this <a href="https://bgreenwell.github.io/pdp/articles/pdp-extending.html">article</a>.</li>
<li>
<code>lambdas</code>: numeric vector with the possible <span class="math inline">\(\lambda\)</span> values to explore. The search grid is created automatically via <code><a href="../reference/lambda_grid.html">maidrr::lambda_grid</a></code>. This grid contains only those values of <span class="math inline">\(\lambda\)</span> that result in a unique grouping of the full set of features. A seperate grid is generated for main and interaction effects.</li>
<li>
<code>nfolds</code>: integer for the number of folds to use in K-fold cross-validation.</li>
<li>
<code>strat_vars</code>: character (vector) specifying the feature(s) to use for stratified sampling in the creation of the folds. The default <code>NULL</code> implies no stratification is applied.</li>
<li>
<code>glm_par</code>: named list, constructed via <code><a href="https://rdrr.io/r/base/list.html">alist()</a></code>, with additional arguments to be passed on to <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code> (see the section on <code>surrogate</code>). Note however that the argument <code>formula</code> will be ignored as the formula is determined automatically by the <code>target</code> and the selected features during the tuning process.</li>
<li>
<code>err_fun</code>: error function to calculate the prediction errors on the validation folds. This must be an R function which outputs a single number and takes two vectors <code>y_pred</code> and <code>y_true</code> as input for the predicted and true target values respectively. An additional input vector <code>w_case</code> is allowed to use case weights in the error function. The weights are determined automatically based on the <code>weights</code> field supplied to <code>glm_par</code>. The following functions are included already, see <code><a href="../reference/err_fun.html">maidrr::err_fun</a></code> for details:
<ul>
<li>
<code>mse</code>: mean squared error loss function.</li>
<li>
<code>wgt_mse</code>: weighted mean squared error loss function.</li>
<li>
<code>poi_dev</code>: Poisson deviance loss function.</li>
</ul>
</li>
<li>
<code>ncores</code>: integer specifying the number of cores to use. The default <code>ncores = -1</code> uses all the available physical cores (not threads).</li>
</ul>
<p>Let’s autotune the <span class="math inline">\(\lambda\)</span> parameter on the BE portfolio:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">5678</span>)
<span class="no">tune_be</span> <span class="kw">&lt;-</span> <span class="no">gbm_be</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/autotune.html">autotune</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">mtpl_be</span>,
                               <span class="kw">vars</span> <span class="kw">=</span> <span class="no">gbm_be</span>$<span class="no">var.names</span>,
                               <span class="kw">target</span> <span class="kw">=</span> <span class="st">'nclaims'</span>,
                               <span class="kw">hcut</span> <span class="kw">=</span> <span class="fl">0.75</span>,
                               <span class="kw">pred_fun</span> <span class="kw">=</span> <span class="no">gbm_fun</span>,
                               <span class="kw">lambdas</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/outer.html">outer</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fl">10</span>, <span class="fl">0.1</span>), <span class="fl">10</span>^(-<span class="fl">7</span>:<span class="fl">3</span>))),
                               <span class="kw">nfolds</span> <span class="kw">=</span> <span class="fl">5</span>,
                               <span class="kw">strat_vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'nclaims'</span>, <span class="st">'expo'</span>),
                               <span class="kw">glm_par</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">alist</a></span>(<span class="kw">family</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span>(<span class="kw">link</span> <span class="kw">=</span> <span class="st">'log'</span>),
                                               <span class="kw">offset</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">expo</span>)),
                               <span class="kw">err_fun</span> <span class="kw">=</span> <span class="no">poi_dev</span>,
                               <span class="kw">ncores</span> <span class="kw">=</span> -<span class="fl">1</span>)</pre></body></html></div>
<p>The output of <code><a href="../reference/autotune.html">maidrr::autotune</a></code> is a <code>list</code> with the following four elements:</p>
<ul>
<li>
<code>slct_feat</code>: named vector containing the selected features (names) and the optimal number of groups for each feature (values).</li>
<li>
<code>best_surr</code>: the optimal GLM surrogate, which is fit to all observations in <code>data</code>. The segmented data can be obtained via the <code>$data</code> attribute of the GLM fit.</li>
<li>
<code>tune_main</code>: the cross-validation results for the main effects as a tidy data frame. The column <code>cv_err</code> contains the cross-validated error, while the columns <code>1:nfolds</code> contain the error on the validation folds.</li>
<li>
<code>tune_intr</code>: the cross-validation results for the interaction effects, in the same format as <code>tune_main</code>.</li>
</ul>
<div class="sourceCode"><html><body><pre class="r"><span class="no">tune_be</span>
<span class="co">#&gt; $slct_feat</span>
<span class="co">#&gt;       ageph       power          bm        agec        fuel     bm_agec </span>
<span class="co">#&gt;           8           9          12           5           2           5 </span>
<span class="co">#&gt; ageph_power    power_bm </span>
<span class="co">#&gt;           5           7 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $best_surr</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:  glm(formula = nclaims ~ 1 + ageph_ + power_ + bm_ + agec_ + fuel_ + </span>
<span class="co">#&gt;     bm_agec_ + ageph_power_ + power_bm_, family = poisson(link = "log"), </span>
<span class="co">#&gt;     data = data, offset = log(expo))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;      (Intercept)    ageph_[18, 20]    ageph_[21, 21]    ageph_[22, 26]  </span>
<span class="co">#&gt;        -2.221037          0.345512          0.227091          0.165859  </span>
<span class="co">#&gt;   ageph_[27, 29]    ageph_[30, 31]    ageph_[50, 57]    ageph_[58, 95]  </span>
<span class="co">#&gt;         0.085189          0.029335         -0.077138         -0.231097  </span>
<span class="co">#&gt;   power_[10, 33]  power_[101, 140]  power_[141, 170]  power_[173, 184]  </span>
<span class="co">#&gt;        -0.146664          0.157926          0.314601          0.885155  </span>
<span class="co">#&gt; power_[190, 243]    power_[34, 38]    power_[39, 44]   power_[68, 100]  </span>
<span class="co">#&gt;         1.035518         -0.062037         -0.037632          0.119632  </span>
<span class="co">#&gt;        bm_[1, 1]       bm_[10, 10]       bm_[11, 13]       bm_[14, 15]  </span>
<span class="co">#&gt;         0.116665          0.665807          0.776818          0.851777  </span>
<span class="co">#&gt;      bm_[16, 17]       bm_[18, 22]         bm_[2, 2]         bm_[3, 5]  </span>
<span class="co">#&gt;         0.945374          0.956184          0.183380          0.321261  </span>
<span class="co">#&gt;        bm_[6, 6]         bm_[7, 7]         bm_[8, 9]       agec_[0, 1]  </span>
<span class="co">#&gt;         0.382210          0.455965          0.542698          0.170450  </span>
<span class="co">#&gt;    agec_[18, 29]       agec_[2, 5]     agec_[30, 48]     fuel_{diesel}  </span>
<span class="co">#&gt;        -0.278210         -0.070014         -1.706916          0.149285  </span>
<span class="co">#&gt;        bm_agec_2         bm_agec_3         bm_agec_5     ageph_power_1  </span>
<span class="co">#&gt;        -0.545768         -0.134153          0.154437         -0.211970  </span>
<span class="co">#&gt;    ageph_power_3     ageph_power_4     ageph_power_5        power_bm_1  </span>
<span class="co">#&gt;         0.064931          0.560979          0.808275         -0.153419  </span>
<span class="co">#&gt;       power_bm_2        power_bm_4        power_bm_5        power_bm_6  </span>
<span class="co">#&gt;        -0.075525         -0.043317          0.103786         -0.251433  </span>
<span class="co">#&gt;       power_bm_7  </span>
<span class="co">#&gt;        -0.002169  </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Degrees of Freedom: 163211 Total (i.e. Null);  163167 Residual</span>
<span class="co">#&gt; Null Deviance:       89880 </span>
<span class="co">#&gt; Residual Deviance: 86980     AIC: 124800</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $tune_main</span>
<span class="co">#&gt; # A tibble: 53 x 16</span>
<span class="co">#&gt;    lambda_main ageph power    bm  agec coverage  fuel   sex fleet   use   `1`</span>
<span class="co">#&gt;          &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1  0.000008       8     9    12     5        1     2     1     1     1 0.535</span>
<span class="co">#&gt;  2  0.0000082      7     8    12     5        1     2     1     1     1 0.535</span>
<span class="co">#&gt;  3  0.0000052      9    10    12     6        2     2     1     1     1 0.535</span>
<span class="co">#&gt;  4  0.00000500    10    10    12     6        2     2     1     1     1 0.535</span>
<span class="co">#&gt;  5  0.0000045     14    11    12     6        2     2     1     1     1 0.535</span>
<span class="co">#&gt;  6  0.0000048     14    10    12     6        2     2     1     1     1 0.535</span>
<span class="co">#&gt;  7  0.0000072      8    10    12     5        1     2     1     1     1 0.535</span>
<span class="co">#&gt;  8  0.000010       6     7    12     4        1     2     1     1     1 0.535</span>
<span class="co">#&gt;  9  0.0000061      8    10    12     6        1     2     1     1     1 0.535</span>
<span class="co">#&gt; 10  0.00000950     7     7    12     4        1     2     1     1     1 0.535</span>
<span class="co">#&gt; # … with 43 more rows, and 5 more variables: `2` &lt;dbl&gt;, `3` &lt;dbl&gt;, `4` &lt;dbl&gt;,</span>
<span class="co">#&gt; #   `5` &lt;dbl&gt;, cv_err &lt;dbl&gt;</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $tune_intr</span>
<span class="co">#&gt; # A tibble: 37 x 10</span>
<span class="co">#&gt;    lambda_intr bm_agec ageph_power power_bm   `1`   `2`   `3`   `4`   `5` cv_err</span>
<span class="co">#&gt;          &lt;dbl&gt;   &lt;int&gt;       &lt;int&gt;    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt;  1    0.000029       5           5        7 0.535 0.534 0.533 0.533 0.533  0.534</span>
<span class="co">#&gt;  2    0.00003        5           5        6 0.535 0.534 0.533 0.533 0.533  0.534</span>
<span class="co">#&gt;  3    0.000041       5           4        6 0.535 0.534 0.533 0.533 0.533  0.534</span>
<span class="co">#&gt;  4    0.000058       5           4        4 0.535 0.534 0.533 0.533 0.533  0.534</span>
<span class="co">#&gt;  5    0.00006        5           3        4 0.535 0.534 0.533 0.533 0.533  0.534</span>
<span class="co">#&gt;  6    0.000043       5           4        5 0.535 0.534 0.533 0.533 0.533  0.534</span>
<span class="co">#&gt;  7    0.000086       5           2        4 0.535 0.534 0.533 0.533 0.533  0.534</span>
<span class="co">#&gt;  8    0.000096       3           2        4 0.535 0.534 0.533 0.533 0.533  0.534</span>
<span class="co">#&gt;  9    0.000025       6           7        7 0.535 0.534 0.533 0.534 0.533  0.534</span>
<span class="co">#&gt; 10    0.000018       7           7        8 0.535 0.534 0.533 0.534 0.533  0.534</span>
<span class="co">#&gt; # … with 27 more rows</span></pre></body></html></div>
<p>Let’s also autotune the <span class="math inline">\(\lambda\)</span> parameter on the FR portfolio:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">5678</span>)
<span class="no">tune_fr</span> <span class="kw">&lt;-</span> <span class="no">gbm_fr</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/autotune.html">autotune</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">mtpl_fr</span>,
                               <span class="kw">vars</span> <span class="kw">=</span> <span class="no">gbm_fr</span>$<span class="no">var.names</span>,
                               <span class="kw">target</span> <span class="kw">=</span> <span class="st">'nclaims'</span>,
                               <span class="kw">hcut</span> <span class="kw">=</span> <span class="fl">0.75</span>,
                               <span class="kw">pred_fun</span> <span class="kw">=</span> <span class="no">gbm_fun</span>,
                               <span class="kw">lambdas</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/outer.html">outer</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fl">10</span>, <span class="fl">0.1</span>), <span class="fl">10</span>^(-<span class="fl">7</span>:<span class="fl">3</span>))),
                               <span class="kw">nfolds</span> <span class="kw">=</span> <span class="fl">5</span>,
                               <span class="kw">strat_vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'nclaims'</span>, <span class="st">'expo'</span>),
                               <span class="kw">glm_par</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">alist</a></span>(<span class="kw">family</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span>(<span class="kw">link</span> <span class="kw">=</span> <span class="st">'log'</span>),
                                               <span class="kw">offset</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">expo</span>)),
                               <span class="kw">err_fun</span> <span class="kw">=</span> <span class="no">poi_dev</span>,
                               <span class="kw">ncores</span> <span class="kw">=</span> -<span class="fl">1</span>)</pre></body></html></div>
<p>These are the optimal groupings obtained for the effects that were shown earlier in this vignette:</p>
<div class="sourceCode"><html><body><pre class="r"><span class="kw pkg">gridExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="no">fx_vars_be</span><span class="kw">[[</span><span class="st">'ageph'</span>]] <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/group_pd.html">group_pd</a></span>(<span class="kw">ngroups</span> <span class="kw">=</span> <span class="no">tune_be</span>$<span class="no">slct_feat</span>[<span class="st">'ageph'</span>]) <span class="kw">%&gt;%</span> <span class="no">plot_pd</span> + <span class="fu">ggtitle</span>(<span class="st">'MTPL BE'</span>),
                        <span class="no">fx_vars_fr</span><span class="kw">[[</span><span class="st">'brand'</span>]] <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/group_pd.html">group_pd</a></span>(<span class="kw">ngroups</span> <span class="kw">=</span> <span class="no">tune_fr</span>$<span class="no">slct_feat</span>[<span class="st">'brand'</span>]) <span class="kw">%&gt;%</span> <span class="no">plot_pd</span> + <span class="fu">ggtitle</span>(<span class="st">'MTPL FR'</span>),
                        <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="maidrr_files/figure-html/autotune_plt-1.png" width="672"></p>
<div class="sourceCode"><html><body><pre class="r"><span class="kw pkg">gridExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="no">fx_vars_be</span><span class="kw">[[</span><span class="st">'ageph_power'</span>]] <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/group_pd.html">group_pd</a></span>(<span class="kw">ngroups</span> <span class="kw">=</span> <span class="no">tune_be</span>$<span class="no">slct_feat</span>[<span class="st">'ageph_power'</span>]) <span class="kw">%&gt;%</span> <span class="no">plot_pd</span> + <span class="fu">ggtitle</span>(<span class="st">'MTPL BE'</span>),
                        <span class="no">fx_vars_fr</span><span class="kw">[[</span><span class="st">'power_fuel'</span>]] <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/group_pd.html">group_pd</a></span>(<span class="kw">ngroups</span> <span class="kw">=</span> <span class="no">tune_fr</span>$<span class="no">slct_feat</span>[<span class="st">'power_fuel'</span>]) <span class="kw">%&gt;%</span> <span class="no">plot_pd</span> + <span class="fu">ggtitle</span>(<span class="st">'MTPL FR'</span>),
                        <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="maidrr_files/figure-html/autotune_plt-2.png" width="672"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Roel Henckaerts.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.0.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
